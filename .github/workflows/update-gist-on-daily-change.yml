# .github/workflows/update-gist-on-daily-change.yml

name: Update Gist on Daily-Add Change

# 监听推送到 main 分支的事件
on:
  push:
    branches:
      - main

jobs:
  update-gist:
    runs-on: ubuntu-latest
    # 需要 contents 权限来检出代码，并且我们需要 secrets
    permissions:
      contents: read

    steps:
      # 步骤 1: 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 获取完整历史，以便我们能比较文件变更
          fetch-depth: 2

      # 步骤 2: 检查 daily-add.json 是否被修改
      - name: Check for file changes
        id: check_changes
        run: |
          # git diff --name-only HEAD^ HEAD 会列出最新一次提交相比上一次提交修改了哪些文件
          # grep -q 'extension/daily-add.json' 会检查列表中是否包含我们的目标文件
          if git diff --name-only HEAD^ HEAD | grep -q 'extension/daily-add.json'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Target file 'extension/daily-add.json' was changed."
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Target file was not changed. Skipping."
          fi

      # 步骤 3: 如果文件被修改，则更新 Gist
      - name: Update Gist
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          # 定义变量
          GIST_ID="6154a4acda6784b87cf318d93eb2b5b0"
          GIST_FILENAME="banana.json"
          PAYLOAD_FILE="payload.json"

          # 1. 读取文件内容并进行必要的转义
          #    这次我们使用更强大的 jq 来进行转义，因为它更可靠
          #    -R 读取原始输入，-s 将其作为单个字符串处理
          ESCAPED_CONTENT=$(jq -Rsa . extension/daily-add.json)

          # 2. 使用 jq 构建完整的 JSON 请求体，并直接写入临时文件
          jq -n --arg filename "$GIST_FILENAME" --arg content "$ESCAPED_CONTENT" \
            '{ "files": { ($filename): { "content": $content } } }' > "$PAYLOAD_FILE"

          # 3. 使用 curl 从临时文件中读取数据并发送请求
          #    -d @payload_file 表示从文件读取数据体
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d @"$PAYLOAD_FILE" \
            "https://api.github.com/gists/$GIST_ID"

          # 4. 清理临时文件
          rm "$PAYLOAD_FILE"

          echo "Gist updated successfully using a temporary file." 



# .github/workflows/update-gist-on-daily-change.yml

name: Update Gist on Daily-Add Change

# ç›‘å¬æ¨é€åˆ° main åˆ†æ”¯çš„äº‹ä»¶
on:
  push:
    branches:
      - main

jobs:
  update-gist:
    runs-on: ubuntu-latest
    # éœ€è¦ contents æƒé™æ¥æ£€å‡ºä»£ç ï¼Œå¹¶ä¸”æˆ‘ä»¬éœ€è¦ secrets
    permissions:
      contents: read

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´å†å²ï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½æ¯”è¾ƒæ–‡ä»¶å˜æ›´
          fetch-depth: 2

      # æ­¥éª¤ 2: æ£€æŸ¥ daily-add.json æ˜¯å¦è¢«ä¿®æ”¹
      - name: Check for file changes
        id: check_changes
        run: |
          # git diff --name-only HEAD^ HEAD ä¼šåˆ—å‡ºæœ€æ–°ä¸€æ¬¡æäº¤ç›¸æ¯”ä¸Šä¸€æ¬¡æäº¤ä¿®æ”¹äº†å“ªäº›æ–‡ä»¶
          # grep -q 'extension/daily-add.json' ä¼šæ£€æŸ¥åˆ—è¡¨ä¸­æ˜¯å¦åŒ…å«æˆ‘ä»¬çš„ç›®æ ‡æ–‡ä»¶
          if git diff --name-only HEAD^ HEAD | grep -q 'extension/daily-add.json'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Target file 'extension/daily-add.json' was changed."
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Target file was not changed. Skipping."
          fi

      # æ­¥éª¤ 3: å¦‚æœæ–‡ä»¶è¢«ä¿®æ”¹ï¼Œåˆ™æ›´æ–° Gist
      - name: Update Gist
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          # ä½¿ç”¨ Python è„šæœ¬æ¥å¤„ç†æ–‡ä»¶ä¸Šä¼ ï¼Œå½»åº•è§£å†³å‚æ•°é•¿åº¦é—®é¢˜
          python3 << 'EOF'
          import json
          import os
          import requests

          # --- é…ç½® ---
          gist_id = "6154a4acda6784b87cf318d93eb2b5b0"
          gist_filename = "banana.json"
          file_to_read = "extension/daily-add.json"
          github_token = os.environ["GITHUB_TOKEN"] # ä»ç¯å¢ƒå˜é‡è¯»å– Token
          # ---

          # 1. è¯»å–è¦ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹
          try:
              with open(file_to_read, 'r', encoding='utf-8') as f:
                  file_content = f.read()
          except FileNotFoundError:
              print(f"Error: Source file '{file_to_read}' not found.")
              exit(1)

          # 2. æ„å»ºç¬¦åˆ GitHub API è¦æ±‚çš„ JSON æ•°æ®ç»“æ„
          # Python çš„ json åº“ä¼šè‡ªåŠ¨å¤„ç†æ‰€æœ‰è½¬ä¹‰é—®é¢˜
          payload = {
              "files": {
                  gist_filename: {
                      "content": file_content
                  }
              }
          }

          # 3. è®¾ç½® API è¯·æ±‚å¤´
          headers = {
              "Authorization": f"token {github_token}",
              "Accept": "application/vnd.github.v3+json"
          }

          # 4. å‘é€ PATCH è¯·æ±‚åˆ° GitHub API
          api_url = f"https://api.github.com/gists/{gist_id}"
          
          print(f"Updating Gist {gist_id} with content from {file_to_read}...")

          try:
              response = requests.patch(api_url, headers=headers, data=json.dumps(payload))
              response.raise_for_status() # å¦‚æœè¯·æ±‚å¤±è´¥ (ä¾‹å¦‚ 4xx, 5xx)ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸
              
              print("âœ… Gist updated successfully!")
              # æ‰“å°æœ€æ–°çš„ raw_url
              latest_raw_url = response.json().get("files", {}).get(gist_filename, {}).get("raw_url")
              if latest_raw_url:
                  print(f"ğŸ”— Latest Raw URL: {latest_raw_url}")

          except requests.exceptions.RequestException as e:
              print(f"âŒ Failed to update Gist.")
              print(f"Error: {e}")
              # å¦‚æœ API è¿”å›äº†é”™è¯¯ä¿¡æ¯ï¼Œæ‰“å°å‡ºæ¥
              if e.response is not None:
                  print(f"Response Body: {e.response.text}")
              exit(1)

          EOF
        env:
          GITHUB_TOKEN: ${{ secrets.GIST_TOKEN }}




# .github/workflows/update-gist-on-daily-change.yml

name: Update Gist on Daily-Add Change

# 监听推送到 main 分支的事件
on:
  push:
    branches:
      - main

jobs:
  update-gist:
    runs-on: ubuntu-latest
    # 需要 contents 权限来检出代码，并且我们需要 secrets
    permissions:
      contents: read

    steps:
      # 步骤 1: 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 获取完整历史，以便我们能比较文件变更
          fetch-depth: 2

      # 步骤 2: 检查 daily-add.json 是否被修改
      - name: Check for file changes
        id: check_changes
        run: |
          # git diff --name-only HEAD^ HEAD 会列出最新一次提交相比上一次提交修改了哪些文件
          # grep -q 'extension/daily-add.json' 会检查列表中是否包含我们的目标文件
          if git diff --name-only HEAD^ HEAD | grep -q 'extension/daily-add.json'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Target file 'extension/daily-add.json' was changed."
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Target file was not changed. Skipping."
          fi

      # 步骤 3: 如果文件被修改，则更新 Gist
      - name: Update Gist
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          # 读取文件内容，并进行必要的转义
          # - 将 \ 转义为 \\
          # - 将 " 转义为 \"
          # - 将 $ 转义为 \$
          # - 将 ` 转义为 \`
          # 这是为了确保 JSON 字符串的格式正确
          FILE_CONTENT=$(cat extension/daily-add.json | sed 's/\\/\\\\/g; s/"/\\"/g; s/\$/\\$/g; s/`/\\`/g')

          GIST_ID="6154a4acda6784b87cf318d93eb2b5b0"
          GIST_FILENAME="banana.json"

          # 使用 printf 构建完整的 JSON 请求体
          # 这比 jq 更稳定，不受参数长度限制
          JSON_PAYLOAD=$(printf '{
            "files": {
              "%s": {
                "content": "%s"
              }
            }
          }' "$GIST_FILENAME" "$FILE_CONTENT")

          # 使用 curl 发送请求
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "$JSON_PAYLOAD" \
            "https://api.github.com/gists/$GIST_ID"

          echo "Gist updated successfully without jq." 

